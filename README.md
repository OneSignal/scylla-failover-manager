# Postgres Failover Manager

This is a simple service that listen to host error events generated by Google Cloud, and if the error
happened in a primary database server, will promote its corresponding replica.

## How does it work?

The system listens to a Google PubSub topic (`projects/core-infra-onesignal/topics/persistence-postgres-host-error`)
that is set to be a notification channel for hosts errors.

In the event of a host error, it will check whether the failing host is a primary database server
by fetching its metadata using the [Compute Engine API](https://cloud.google.com/compute/docs/reference/rest/v1). If
that's the case, it will find a host which `ansible_replica_of` label points to this primary (again, using the Compute Engine API).

If it finds a valid replica, it tries to promote it. To do so, it connects to the server to configure it as a `write enabled` server
and updates the `rw` DNS record pointing to the failing primary to point to the replica. This is done using
[Cloud DNS API](https://cloud.google.com/dns/docs/reference/rest/v1).

The system performs many validations throughout the process to ensure current state at the time of the event is what we expect and does
nothing if it finds any inconsistency.

## Executing the service

The service is a simple unix daemon.

```
Usage: scylla-failover-manager [OPTIONS] --db-override-password <DB_OVERRIDE_PASSWORD>

Options:
  -t, --topic <TOPIC>
          Name of the topic to subscribe to for listenting to host error messages [default: persistence-postgres-host-error]
  -e, --environment <ENVIRONMENT>
          Environment [default: production]
  -d, --dry-run
          Dry run
      --db-override-password <DB_OVERRIDE_PASSWORD>
          Postgres user password [env: DB_OVERRIDE_PASSWORD=]
  -h, --help
          Print help
  -V, --version
          Print version
```

## Develop

There is a `docker-compose.yml` file with a simple container for building/runing tests and an emulator of pubsub. I also contains
postgres server binaries so we can run integration tests.

## Testing

A simple tool is also provided that generate fake log entries. This tool will send log events to the topic.
**THIS IS AIMED TO BE USED ONLY FOR TESTING PURPOSES AND IN STAGING, DONT USE THIS USING PRODUCTION HOSTNAMES**

```
Usage: force-host-error [OPTIONS] <HOST> <ZONE>

Arguments:
  <HOST>  Host to mark as failed
  <ZONE>  Zone of the host

Options:
  -t, --topic <TOPIC>  Name of the topic to send messages to [default: persistence-postgres-host-error]
  -d, --dry-run        Dry run
  -h, --help           Print help
  -V, --version        Print version
```
